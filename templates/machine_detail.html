<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Machine Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-full bg-gray-50 text-gray-800 antialiased dark:bg-gray-950 dark:text-gray-100">
<div class="mx-auto max-w-7xl px-4 py-8">
    <header class="mb-6 flex items-center gap-4">
        <a href="/" class="rounded-lg border border-gray-300 px-4 py-1 text-sm font-medium shadow-sm hover:bg-gray-100 dark:border-gray-700 dark:bg-gray-900 dark:hover:bg-gray-800">&larr; Back</a>
        <h1 class="text-xl font-bold">Machine: {{ machine.name }} ({{ machine.mac }})</h1>
    </header>

    <section class="mb-6">
        <div class="mb-3 flex items-center justify-between">
            <h2 class="text-lg font-semibold">Port Forwards</h2>
        </div>
        <form method="post" action="/machines/update-ports" class="overflow-x-auto rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-800 dark:bg-gray-900">
            <input type="hidden" name="mac" value="{{ machine.mac }}" />
            <table class="min-w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-600 dark:bg-gray-950 dark:text-gray-300">
                    <tr>
                        <th class="px-4 py-3 font-semibold">Name</th>
                        <th class="px-4 py-3 font-semibold">Local Port</th>
                        <th class="px-4 py-3 font-semibold">Target Port</th>
                        <th class="px-4 py-3 font-semibold">Remove</th>
                    </tr>
                </thead>
                <tbody>
                    {% for (idx, pf) in machine.port_forwards.iter().enumerate() %}
                    <tr>
                        <td class="px-3 py-1">
                            <input type="text" name="pf_name_{{ idx }}" value="{{ pf.name }}" class="border rounded px-2 py-1 w-full" />
                        </td>
                        <td class="px-3 py-1">
                            <input type="number" name="pf_local_{{ idx }}" value="{{ pf.local_port }}" class="border rounded px-2 py-1 w-full" />
                        </td>
                        <td class="px-3 py-1">
                            <input type="number" name="pf_target_{{ idx }}" value="{{ pf.target_port }}" class="border rounded px-2 py-1 w-full" />
                        </td>
                        <td class="px-3 py-1 text-center">
                            <input type="checkbox" name="pf_remove_{{ idx }}" />
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td class="px-4 py-2"><input type="text" name="pf_name_new" placeholder="New Name" class="rounded-lg border border-gray-300 bg-white px-2 py-1 text-sm shadow-sm dark:border-gray-700 dark:bg-gray-950 w-full" /></td>
                        <td class="px-4 py-2"><input type="number" name="pf_local_new" placeholder="New Local Port" class="rounded-lg border border-gray-300 bg-white px-2 py-1 text-sm shadow-sm dark:border-gray-700 dark:bg-gray-950 w-full" /></td>
                        <td class="px-4 py-2"><input type="number" name="pf_target_new" placeholder="New Target Port" class="rounded-lg border border-gray-300 bg-white px-2 py-1 text-sm shadow-sm dark:border-gray-700 dark:bg-gray-950 w-full" /></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            <div class="mt-4 flex justify-end">
                <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 active:scale-[0.99]">Save Port Changes</button>
            </div>
        </form>
    </section>

    <section class="mt-8">
        <div class="mb-3">
            <h2 class="text-lg font-semibold">Machine Info</h2>
        </div>
        <div class="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-800 dark:bg-gray-900 grid grid-cols-1 sm:grid-cols-2 gap-y-3 gap-x-12">
            <div>
                <div class="text-xs font-semibold text-gray-500">MAC</div>
                <div class="font-mono">{{ machine.mac }}</div>
            </div>
            <div>
                <div class="text-xs font-semibold text-gray-500">IP</div>
                <div class="font-mono">{{ machine.ip }}</div>
            </div>
            <div>
                <div class="text-xs font-semibold text-gray-500">Name</div>
                <div>{{ machine.name }}</div>
            </div>
            <div>
                <div class="text-xs font-semibold text-gray-500">Description</div>
                <div>{% if let Some(desc) = machine.description.as_deref() %}{{ desc }}{% else %}-{% endif %}</div>
            </div>
            <div>
                <div class="text-xs font-semibold text-gray-500">Requests per Hour</div>
                <div>{{ machine.request_rate.max_requests }}</div>
            </div>
            <div>
                <div class="text-xs font-semibold text-gray-500">Status</div>
                <div>
                    <div class="machine-health-badge" data-ip="{{ machine.ip }}" data-turn-off-port="{% if let Some(port) = machine.turn_off_port %}{{ port }}{% else %}0{% endif %}">
                        <span class="inline-flex items-center rounded-full bg-green-100 px-2 py-1 text-xs font-medium text-green-800 dark:bg-green-900 dark:text-green-200">
                            <span class="h-2 w-2 rounded-full bg-green-500 mr-1"></span>
                            Online
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section class="mt-8">
        <div class="mb-3">
            <h2 class="text-lg font-semibold">Machine Configuration</h2>
        </div>
        <form action="/machines/update-config" method="post" class="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-800 dark:bg-gray-900 max-w-lg grid gap-6">
            <input type="hidden" name="mac" value="{{ machine.mac }}">
            <div class="grid gap-2">
                <label for="name" class="text-sm font-medium">Name</label>
                <input type="text" id="name" name="name" required class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" value="{{ machine.name }}">
            </div>
            <div class="grid gap-2">
                <label for="description" class="text-sm font-medium">Description</label>
                <input type="text" id="description" name="description" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" value="{% if let Some(desc) = machine.description.as_deref() %}{{ desc }}{% else %}{% endif %}">
            </div>
            <div class="grid gap-2">
                <label for="requests_per_hour" class="text-sm font-medium">Requests per Hour</label>
                <input type="number" id="requests_per_hour" name="requests_per_hour" min="1" value="{{ machine.request_rate.max_requests }}" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950">
            </div>
            <div class="grid gap-2">
                <label for="period_minutes" class="text-sm font-medium">Period Minutes</label>
                <input type="number" id="period_minutes" name="period_minutes" min="1" value="{{ machine.request_rate.period_minutes }}" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950">
            </div>
            <div class="flex items-center gap-2">
                <input type="checkbox" id="can_be_turned_off" name="can_be_turned_off" value="true" {% if machine.can_be_turned_off %}checked{% endif %} />
                <label for="can_be_turned_off" class="text-sm">Can be turned off remotely</label>
            </div>
            <div class="grid gap-2" id="turn_off_port_container" style="display: none;">
                <label for="turn_off_port" class="text-sm font-medium">Turn Off Port</label>
                <input type="number" id="turn_off_port" name="turn_off_port" min="1" max="65535" value="{% if let Some(port) = machine.turn_off_port %}{{ port }}{% else %}3000{% endif %}" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950">
            </div>
            <div class="flex justify-end">
                <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 active:scale-[0.99]">Save Config</button>
            </div>
        </form>
    </section>
</div>
<script>
    // Machine health check function
    async function checkMachineHealth(machineIp, turnOffPort) {
        try {
            const response = await fetch('/machine/health', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ip: machineIp,
                    turn_off_port: parseInt(turnOffPort)
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Health check error:', error);
            return { status: 'error', message: error.message };
        }
    }
    
    // Update health badge
    function updateHealthBadge(badge, healthData) {
        const badgeElement = badge.querySelector('span');
        const dotElement = badgeElement.querySelector('span');
        
        if (healthData.status === 'online') {
            badgeElement.className = 'inline-flex items-center rounded-full bg-green-100 px-2 py-1 text-xs font-medium text-green-800 dark:bg-green-900 dark:text-green-200';
            dotElement.className = 'h-2 w-2 rounded-full bg-green-500 mr-1';
            badgeElement.innerHTML = '<span class="h-2 w-2 rounded-full bg-green-500 mr-1"></span>Online';
        } else if (healthData.status === 'offline' || healthData.status === 'error') {
            badgeElement.className = 'inline-flex items-center rounded-full bg-red-100 px-2 py-1 text-xs font-medium text-red-800 dark:bg-red-900 dark:text-red-200';
            dotElement.className = 'h-2 w-2 rounded-full bg-red-500 mr-1';
            badgeElement.innerHTML = '<span class="h-2 w-2 rounded-full bg-red-500 mr-1"></span>Offline';
        } else {
            badgeElement.className = 'inline-flex items-center rounded-full bg-gray-100 px-2 py-1 text-xs font-medium text-gray-800 dark:bg-gray-800 dark:text-gray-200';
            dotElement.className = 'h-2 w-2 rounded-full bg-gray-400 mr-1';
            badgeElement.innerHTML = '<span class="h-2 w-2 rounded-full bg-gray-400 mr-1"></span>Unknown';
        }
    }
    
    // Check health for the current machine
    async function checkMachineHealthStatus() {
        const badge = document.querySelector('.machine-health-badge');
        if (!badge) return;
        
        const machineIp = badge.dataset.ip;
        const turnOffPort = badge.dataset.turnOffPort;
        
        const healthData = await checkMachineHealth(machineIp, turnOffPort);
        updateHealthBadge(badge, healthData);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle turn off port field
        const canTurnOffCheckbox = document.getElementById('can_be_turned_off');
        const turnOffPortContainer = document.getElementById('turn_off_port_container');
        if (canTurnOffCheckbox.checked) {
            turnOffPortContainer.style.display = 'block';
        }
        canTurnOffCheckbox.addEventListener('change', () => {
            if (canTurnOffCheckbox.checked) {
                turnOffPortContainer.style.display = 'block';
            } else {
                turnOffPortContainer.style.display = 'none';
            }
        });
        
        checkMachineHealthStatus();
        
        // Check health every 30 seconds
        setInterval(checkMachineHealthStatus, 30000);
    });
</script>
</body>
</html>

