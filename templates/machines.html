<!DOCTYPE html>
<html lang="en" class="h-full">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport"
              content="width=device-width, initial-scale=1, viewport-fit=cover" />
        <title>WOL Manager</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
      // Tailwind config (optional: enables class-based dark mode)
      tailwind.config = {
        darkMode: 'media',
        theme: {
          extend: {
            fontFamily: { sans: ['ui-sans-serif', 'system-ui', 'Inter', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif'] }
          }
        }
      }
        </script>
    </head>
    <body class="min-h-full bg-gray-50 text-gray-800 antialiased dark:bg-gray-950 dark:text-gray-100">
        <!-- Page wrapper -->
        <div class="mx-auto max-w-6xl px-4 py-8">
            <!-- Header -->
            <header class="mb-6 flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">WOL Manager</h1>
                    <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Wake, manage, and forward to your registered machines.</p>
                </div>
                <button id="scan-btn"
                        class="inline-flex items-center justify-center rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-medium shadow-sm transition hover:bg-gray-50 active:scale-[0.99] disabled:cursor-not-allowed disabled:opacity-60 dark:border-gray-700 dark:bg-gray-900 dark:hover:bg-gray-800">
                    üîç Scan Network
                </button>
            </header>
            <!-- Discovered devices -->
            <section id="scan-results-container" class="hidden">
                <div class="mb-3 flex items-center justify-between">
                    <h2 class="text-lg font-semibold">Discovered Devices</h2>
                    <span id="scan-status"
                          class="text-sm text-gray-500 dark:text-gray-400"
                          aria-live="polite"></span>
                </div>
                <div class="overflow-x-auto rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-800 dark:bg-gray-900">
                    <table id="scan-results-table" class="min-w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-600 dark:bg-gray-950 dark:text-gray-300">
                            <tr>
                                <th class="px-4 py-3 font-semibold">IP Address</th>
                                <th class="px-4 py-3 font-semibold">Hostname</th>
                                <th class="px-4 py-3 font-semibold">MAC Address</th>
                                <th class="px-4 py-3 font-semibold">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
                        </tbody>
                    </table>
                </div>
            </section>
            <!-- Registered Machines -->
            <section class="mt-8">
                <div class="mb-3 flex items-center justify-between">
                    <h2 class="text-lg font-semibold">Registered Machines</h2>
                </div>
                <div class="overflow-x-auto rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-800 dark:bg-gray-900">
                    <table class="min-w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-600 dark:bg-gray-950 dark:text-gray-300">
                            <tr>
                                <th class="px-4 py-3 font-semibold">Name</th>
                                <th class="px-4 py-3 font-semibold">MAC Address</th>
                                <th class="px-4 py-3 font-semibold">IP Address</th>
                                <th class="px-4 py-3 font-semibold">Description</th>
                                <th class="px-4 py-3 font-semibold">Turn Off Port</th>
                                <th class="px-4 py-3 font-semibold">Can Be Turned Off</th>
                                <th class="px-4 py-3 font-semibold">Port Forwards</th>
                                <th class="px-4 py-3 font-semibold">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
                            {% for m in machines %}
                                <tr class="align-middle">
                                    <td class="px-4 py-3 text-xs sm:text-sm"><a class="underline text-blue-700 dark:text-blue-400 hover:text-blue-900" href="/machines/{{ m.mac }}">{{ m.name }}</a></td>
                                    <td class="px-4 py-3 font-mono text-xs sm:text-sm">{{ m.mac }}</td>
                                    <td class="px-4 py-3 font-mono text-xs sm:text-sm">{{ m.ip }}</td>
                                    <td class="px-4 py-3">
                                        <span class="text-xs sm:text-sm">
                                            {% if let Some(desc) = m.description.as_deref() %}
                                                {% if !desc.is_empty() %}
                                                    {{ desc }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="font-mono text-xs sm:text-sm">
                                            {% if let Some(port) = m.turn_off_port %}
                                                {{ port }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="text-xs sm:text-sm">
                                            {{ m.can_be_turned_off }}
                                        </span>
                                    </td>
                                                                        <td class="px-4 py-3">
                                        <div class="flex flex-col gap-1">
                                            {% for pf in m.port_forwards %}
                                                <span class="font-mono text-xs sm:text-sm">{{ pf.local_port }} -> {{ pf.target_port }} ({{ pf.name }})</span>
                                            {% endfor %}
                                        </div>
                                        <form action="/machines/add-port-forward" method="post" class="mt-2 flex flex-wrap gap-2">
                                            <input type="hidden" name="mac" value="{{ m.mac }}">
                                            <input type="text" name="name" placeholder="Name" class="w-20 rounded-lg border border-gray-300 bg-white px-2 py-1 text-xs shadow-sm" required>
                                            <input type="number" name="local_port" placeholder="Local" class="w-20 rounded-lg border border-gray-300 bg-white px-2 py-1 text-xs shadow-sm" min="1" max="65535" required>
                                            <input type="number" name="target_port" placeholder="Target" class="w-20 rounded-lg border border-gray-300 bg-white px-2 py-1 text-xs shadow-sm" min="1" max="65535" required>
                                            <button type="submit" class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-2 py-1 text-xs font-semibold text-white shadow-sm transition hover:bg-blue-700 active:scale-[0.99]">‚ûï Add Port</button>
                                        </form>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="flex flex-wrap gap-2">
                                            <form action="/wol" method="post" class="wol-form">
                                                <input type="hidden" name="mac" value="{{ m.mac }}">
                                                <button type="submit"
                                                        class="inline-flex items-center justify-center rounded-lg bg-emerald-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-emerald-700 active:scale-[0.99]">
                                                    ‚ö° Wake Up
                                                </button>
                                            </form>
                                            {% if m.turn_off_port.is_some() %}
                                            <form action="/machines/remote-turn-off" method="post" class="turn-off-form">
                                                <input type="hidden" name="mac" value="{{ m.mac }}">
                                                <button type="submit"
                                                        class="inline-flex items-center justify-center rounded-lg bg-amber-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-amber-700 active:scale-[0.99]">
                                                    üîå Turn Off
                                                </button>
                                            </form>
                                            {% endif %}
                                            <form action="/machines/delete"
                                                  method="post"
                                                  onsubmit="return confirm('Remove this machine?');">
                                                <input type="hidden" name="mac" value="{{ m.mac }}">
                                                <button type="submit"
                                                        class="inline-flex items-center justify-center rounded-lg bg-rose-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-rose-700 active:scale-[0.99]">
                                                    üóëÔ∏è Remove
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
            <!-- Add Machine -->
            <section class="mt-10">
                <h2 class="mb-4 text-lg font-semibold">Add New Machine</h2>
                <form action="/machines"
                      method="post"
                      id="add-machine-form"
                      class="grid gap-6 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-800 dark:bg-gray-900">
                    <div class="grid gap-2">
                        <label for="mac" class="text-sm font-medium">MAC Address</label>
                        <input type="text"
                               id="mac"
                               name="mac"
                               required
                               inputmode="text"
                               placeholder="00:11:22:33:44:55"
                               class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 font-mono text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" />
                        <p class="text-xs text-gray-500">Formats like 00:11:22:33:44:55 or 001122334455.</p>
                    </div>
                    <div class="grid gap-2">
                        <label for="ip" class="text-sm font-medium">Machine IP Address</label>
                        <input type="text"
                               id="ip"
                               name="ip"
                               required
                               inputmode="numeric"
                               placeholder="192.168.1.42"
                               class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 font-mono text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" />
                    </div>
                    <div class="grid gap-2">
                        <label for="name" class="text-sm font-medium">Machine Name</label>
                        <input type="text"
                               id="name"
                               name="name"
                               required
                               placeholder="e.g. My Gaming PC"
                               class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" />
                    </div>
                    <div class="grid gap-2">
                        <label for="description" class="text-sm font-medium">Description (optional)</label>
                        <input type="text"
                               id="description"
                               name="description"
                               placeholder="e.g. My Gaming PC"
                               class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" />
                    </div>

                    <div class="grid gap-2">
                        <label for="requests_per_hour" class="text-sm font-medium">Requests per Hour</label>
                        <input type="number"
                               id="requests_per_hour"
                               name="requests_per_hour"
                               value="1000"
                               min="1"
                               class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 font-mono text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" />
                        <p class="text-xs text-gray-500">Defaults to 1000. Controls allowed requests per hour.</p>
                    </div>

                    <div class="grid gap-2">
                        <label for="period_minutes" class="text-sm font-medium">Period Minutes</label>
                        <input type="number"
                               id="period_minutes"
                               name="period_minutes"
                               value="60"
                               min="1"
                               class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 font-mono text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" />
                        <p class="text-xs text-gray-500">Defaults to 60. Controls the period in minutes for request counting.</p>
                    </div>

                    <div class="border-t border-dashed border-gray-200 pt-4 dark:border-gray-800">
                        <h3 class="mb-3 text-base font-semibold">Remote Shutdown (optional)</h3>
                        <div class="flex items-start gap-3">
                            <input type="checkbox" id="can_be_turned_off" name="can_be_turned_off" value="true" class="mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-800 dark:ring-offset-gray-900">
                            <div>
                                <label for="can_be_turned_off" class="text-sm font-medium">Can be turned off remotely</label>
                                <p class="text-xs text-gray-500">Requires the target machine to be running the client_server.</p>
                            </div>
                        </div>
                        <div id="turn_off_port_container" class="hidden mt-4 grid gap-2">
                            <label for="turn_off_port" class="text-sm font-medium">Turn Off Port</label>
                            <input type="number"
                                   id="turn_off_port"
                                   name="turn_off_port"
                                   min="1"
                                   max="65535"
                                   value="3001"
                                   class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 font-mono text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" />
                        </div>
                        
                    </div>
                    <div class="flex items-center justify-end gap-3">
                        <button type="reset"
                                class="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium shadow-sm transition hover:bg-gray-50 active:scale-[0.99] dark:border-gray-700 dark:bg-gray-900 dark:hover:bg-gray-800">
                            Clear
                        </button>
                        <input type="submit"
                               value="Add Machine"
                               class="inline-flex cursor-pointer items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 active:scale-[0.99]" />
                    </div>
                </form>
            </section>
        </div>
        <!-- Scripts -->
        <script>
      const canTurnOffCheckbox = document.getElementById('can_be_turned_off');
      const turnOffPortContainer = document.getElementById('turn_off_port_container');
      canTurnOffCheckbox.addEventListener('change', () => {
        turnOffPortContainer.classList.toggle('hidden', !canTurnOffCheckbox.checked);
      });

      const scanBtn = document.getElementById('scan-btn');
      const resultsContainer = document.getElementById('scan-results-container');
      const resultsTableBody = document.querySelector('#scan-results-table tbody');
      const scanStatus = document.getElementById('scan-status');

      function showResults() {
        resultsContainer.classList.remove('hidden');
      }

      scanBtn.addEventListener('click', async () => {
        scanBtn.textContent = 'üîé Scanning‚Ä¶';
        scanBtn.disabled = true;
        scanStatus.textContent = 'Scanning your network, this may take a moment‚Ä¶';
        resultsTableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-gray-500">Scanning‚Ä¶</td></tr>';
        showResults();

        try {
          const response = await fetch('/scan');
          if (!response.ok) throw new Error('Network scan failed');
          const devices = await response.json();

          resultsTableBody.innerHTML = '';
          if (!devices.length) {
            resultsTableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-gray-500">No devices found.</td></tr>';
          } else {
            devices.forEach(device => {
              const row = document.createElement('tr');
              row.className = 'align-middle';
              row.innerHTML = `
                <td class="px-4 py-3 font-mono text-xs sm:text-sm">${device.ip}</td>
                <td class="px-4 py-3 text-xs sm:text-sm">${device.hostname || '-'}</td>
                <td class="px-4 py-3 font-mono text-xs sm:text-sm">${device.mac}</td>
                <td class="px-4 py-3">
                  <button class="add-discovered-btn inline-flex items-center justify-center rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-indigo-700 active:scale-[0.99]" data-ip="${device.ip}" data-mac="${device.mac}" data-hostname="${device.hostname || ''}">
                    ‚ûï Add
                  </button>
                </td>`;
              resultsTableBody.appendChild(row);
            });
          }
          scanStatus.textContent = `Found ${devices.length} device${devices.length === 1 ? '' : 's'}.`;
        } catch (err) {
          console.error('Scan error:', err);
          resultsTableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-rose-600">Error during scan. Check server logs.</td></tr>';
          scanStatus.textContent = 'Scan failed.';
        } finally {
          scanBtn.textContent = 'üîç Scan Network';
          scanBtn.disabled = false;
          setTimeout(() => (scanStatus.textContent = ''), 4000);
        }
      });

      document.getElementById('scan-results-table').addEventListener('click', (event) => {
        if (event.target.classList.contains('add-discovered-btn')) {
          const btn = event.target;
          document.getElementById('ip').value = btn.dataset.ip;
          document.getElementById('mac').value = btn.dataset.mac;
          document.getElementById('description').value = btn.dataset.hostname;
          document.getElementById('add-machine-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });

      document.querySelectorAll('.wol-form').forEach(form => {
        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          const button = form.querySelector('button[type="submit"]');
          const originalText = button.innerHTML;
          button.innerHTML = '‚ö° Sending‚Ä¶';
          button.disabled = true;

          try {
            const formData = new FormData(form);
            const response = await fetch(form.action, {
              method: form.method,
              body: new URLSearchParams(formData)
            });
            const responseText = await response.text();
            if (!response.ok) {
              throw new Error(responseText);
            }
            alert(responseText);
          } catch (error) {
            console.error('WOL error:', error);
            alert(`Error: ${error.message}`);
          } finally {
            button.innerHTML = originalText;
            button.disabled = false;
          }
        });
      });

      document.querySelectorAll('.turn-off-form').forEach(form => {
        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!confirm('Turn off this machine?')) return;

          const button = form.querySelector('button[type="submit"]');
          const originalText = button.innerHTML;
          button.innerHTML = 'üîå Sending‚Ä¶';
          button.disabled = true;

          try {
            const formData = new FormData(form);
            const response = await fetch(form.action, {
              method: form.method,
              body: new URLSearchParams(formData)
            });
            const responseText = await response.text();
            if (!response.ok) {
              throw new Error(responseText);
            }
            alert(responseText);
          } catch (error) {
            console.error('Turn off error:', error);
            alert(`Error: ${error.message}`);
          } finally {
            button.innerHTML = originalText;
            button.disabled = false;
          }
        });
      });
        </script>
    </body>
</html>
