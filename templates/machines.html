<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Wakezilla</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind config (optional: enables class-based dark mode)
    tailwind.config = {
      darkMode: 'media',
      theme: {
        extend: {
          fontFamily: {sans: ['ui-sans-serif', 'system-ui', 'Inter', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif']}
        }
      }
    }
  </script>
</head>

<body class="min-h-full bg-gray-50 text-gray-800 antialiased dark:bg-gray-950 dark:text-gray-100">
  <!-- Page wrapper -->
  <div class="mx-auto max-w-6xl px-4 py-8">

    <!-- Header -->
    <header class="mb-6 flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">Wakezilla Manager</h1>
        <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Wake, manage, and forward to your registered machines.
        </p>
      </div>
      <button id="scan-btn"
        class="inline-flex items-center justify-center rounded-xl border border-gray-300 bg-white px-4 py-2 text-sm font-medium shadow-sm transition hover:bg-gray-50 active:scale-[0.99] disabled:cursor-not-allowed disabled:opacity-60 dark:border-gray-700 dark:bg-gray-900 dark:hover:bg-gray-800">
        üîç Scan Network
      </button>
    </header>
    <!-- Discovered devices -->
    <section id="scan-results-container" class="hidden">
      <div class="mb-3 flex items-center justify-between">
        <h2 class="text-lg font-semibold">Discovered Devices</h2>
        <span id="scan-status" class="text-sm text-gray-500 dark:text-gray-400" aria-live="polite"></span>
      </div>
      <div
        class="overflow-x-auto rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-800 dark:bg-gray-900">
        <table id="scan-results-table" class="min-w-full text-left text-sm">
          <thead class="bg-gray-50 text-gray-600 dark:bg-gray-950 dark:text-gray-300">
            <tr>
              <th class="px-4 py-3 font-semibold">IP Address</th>
              <th class="px-4 py-3 font-semibold">Hostname</th>
              <th class="px-4 py-3 font-semibold">MAC Address</th>
              <th class="px-4 py-3 font-semibold">Action</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
          </tbody>
        </table>
      </div>
    </section>
    <!-- Registered Machines -->
    <section class="mt-8">
      <div class="mb-3 flex items-center justify-between">
        <h2 class="text-lg font-semibold">Registered Machines</h2>
      </div>
      <div
        class="overflow-x-auto rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-800 dark:bg-gray-900">
        <table class="min-w-full text-left text-sm">
          <thead class="bg-gray-50 text-gray-600 dark:bg-gray-950 dark:text-gray-300">
            <tr>
              <th class="px-4 py-3 font-semibold">Name</th>
              <th class="px-4 py-3 font-semibold">MAC Address</th>
              <th class="px-4 py-3 font-semibold">IP Address</th>
              <th class="px-4 py-3 font-semibold">Description</th>
              <th class="px-4 py-3 font-semibold">Turn Off Port</th>
              <th class="px-4 py-3 font-semibold">Can Be Turned Off</th>
              <th class="px-4 py-3 font-semibold">Status</th>
              <th class="px-4 py-3 font-semibold w-64">Port Forwards</th>
              <th class="px-4 py-3 font-semibold">Action</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
            {% for m in machines %}
            <tr class="align-middle">
              <td class="px-4 py-3 text-xs sm:text-sm"><a
                  class="underline text-blue-700 dark:text-blue-400 hover:text-blue-900" href="/machines/{{ m.mac }}">{{
                  m.name }}</a></td>
              <td class="px-4 py-3 font-mono text-xs sm:text-sm">{{ m.mac }}</td>
              <td class="px-4 py-3 font-mono text-xs sm:text-sm">{{ m.ip }}</td>
              <td class="px-4 py-3">
                <span class="text-xs sm:text-sm">
                  {% if let Some(desc) = m.description.as_deref() %}
                  {% if !desc.is_empty() %}
                  {{ desc }}
                  {% else %}
                  -
                  {% endif %}
                  {% else %}
                  -
                  {% endif %}
                </span>
              </td>
              <td class="px-4 py-3">
                <span class="font-mono text-xs sm:text-sm">
                  {% if let Some(port) = m.turn_off_port %}
                  {{ port }}
                  {% else %}
                  -
                  {% endif %}
                </span>
              </td>
              <td class="px-4 py-3">
                <span class="text-xs sm:text-sm">
                  {{ m.can_be_turned_off }}
                </span>
              </td>
              <td class="px-4 py-3">
                <div class="machine-health-badge" data-ip="{{ m.ip }}"
                  data-turn-off-port="{% if let Some(port) = m.turn_off_port %}{{ port }}{% else %}0{% endif %}">
                  <span
                    class="inline-flex items-center rounded-full bg-gray-100 px-2 py-1 text-xs font-medium text-gray-800 dark:bg-gray-800 dark:text-gray-200">
                    <span class="h-2 w-2 rounded-full bg-gray-400 mr-1"></span>
                    Checking...
                  </span>
                </div>
              </td>
              <td class="px-4 py-3">
                <div class="flex flex-col gap-1">
                  {% for pf in m.port_forwards %}
                  <span class="font-mono text-xs sm:text-sm">{{ pf.local_port }} -> {{ pf.target_port }} ({{ pf.name
                    }})</span>
                  {% endfor %}
                  {% if m.port_forwards.is_empty() %}
                  <span class="text-gray-500 text-xs">-</span>
                  {% endif %}
                </div>
                <form action="/machines/add-port-forward" method="post" class="mt-1 flex flex-col items-center gap-2">
                  <div class="flex items-center gap-1">
                    <input type="text" name="name" placeholder="Name"
                      class="w-16 h-6 rounded border border-gray-300 bg-white px-1 text-xs shadow-sm" required>
                    <input type="number" name="local_port" placeholder="Local"
                      class="w-16 h-6 rounded border border-gray-300 bg-white px-1 text-xs shadow-sm" min="1"
                      max="65535" required>
                    <span class="text-xs text-gray-400">‚Üí</span>
                    <input type="number" name="target_port" placeholder="Target"
                      class="w-16 h-6 rounded border border-gray-300 bg-white px-1 text-xs shadow-sm" min="1"
                      max="65535" required>

                  </div>
                  <button type="submit"
                    class="h-6 px-2 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition">‚ûï</button>
                  <input type="hidden" name="mac" value="{{ m.mac }}">
                </form>
              </td>
              <td class="px-4 py-3">
                <div class="flex flex-wrap gap-2">
                  <form action="/wol" method="post" class="wol-form">
                    <input type="hidden" name="mac" value="{{ m.mac }}">
                    <button type="submit"
                      class="inline-flex items-center justify-center rounded-lg bg-emerald-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-emerald-700 active:scale-[0.99]">
                      ‚ö° Wake Up
                    </button>
                  </form>
                  {% if m.turn_off_port.is_some() %}
                  <form action="/machines/remote-turn-off" method="post" class="turn-off-form">
                    <input type="hidden" name="mac" value="{{ m.mac }}">
                    <button type="submit"
                      class="inline-flex items-center justify-center rounded-lg bg-amber-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-amber-700 active:scale-[0.99]">
                      üîå Turn Off
                    </button>
                  </form>
                  {% endif %}
                  <form action="/machines/delete" method="post" onsubmit="return confirm('Remove this machine?');">
                    <input type="hidden" name="mac" value="{{ m.mac }}">
                    <button type="submit"
                      class="inline-flex items-center justify-center rounded-lg bg-rose-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-rose-700 active:scale-[0.99]">
                      üóëÔ∏è Remove
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    <!-- Add Machine -->
    <section class="mt-10">
      <h2 class="mb-4 text-lg font-semibold">Add New Machine</h2>
      <form action="/machines" method="post" id="add-machine-form"
        class="grid gap-6 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-800 dark:bg-gray-900">
        <div class="grid gap-2">
          <label for="mac" class="text-sm font-medium">MAC Address</label>
          <input type="text" id="mac" name="mac" required value="{% if let Some(f) = form %}{{ f.mac }}{% endif %}"
            inputmode="text" placeholder="00:11:22:33:44:55"
            class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 font-mono text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" />
          <p class="text-xs text-gray-500">Formats like 00:11:22:33:44:55 or 001122334455.</p>
          {% if let Some(field_errors) = errors.get("mac") %}
          <div class="mb-2">
            {% for error in field_errors %}
            <p class="text-sm text-red-600">{{ error}}</p>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        <div class="grid gap-2">
          <label for="ip" class="text-sm font-medium">Machine IP Address</label>
          <input type="text" id="ip" name="ip" required value="{% if let Some(f) = form %}{{ f.ip }}{% endif %}"
            inputmode="numeric" placeholder="192.168.1.42"
            class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 font-mono text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" />

          {% if let Some(field_errors) = errors.get("ip") %}
          <div class="mb-2">
            {% for error in field_errors %}
            <p class="text-sm text-red-600">{{ error}}</p>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        <div class="grid gap-2">
          <label for="name" class="text-sm font-medium">Machine Name</label>
          <input type="text" id="name" value="{% if let Some(f) = form %}{{ f.name }}{% endif %}" name="name" required
            placeholder="e.g. My Gaming PC"
            class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" />

        </div>
        <div class="grid gap-2">
          <label for="description" class="text-sm font-medium">Description (optional)</label>
          <input type="text" id="description"
            value="{% if let Some(f) = form %}{% if let Some(description) = f.description %}{{description}} {% endif %}{% endif %}"
            name="description" placeholder="e.g. My Gaming PC"
            class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" />
        </div>

        <div class="grid gap-2">
          <label for="requests_per_hour" class="text-sm font-medium">Requests per Hour</label>
          <input type="number" id="requests_per_hour" name="requests_per_hour"
            value="{% if let Some(f) = form %}{{ f.requests_per_hour.unwrap_or(1000) }}{% else %}1000{% endif %}"
            min="1"
            class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 font-mono text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" />
          <p class="text-xs text-gray-500">Defaults to 1000. Controls allowed requests per hour.</p>
        </div>

        <div class="grid gap-2">
          <label for="period_minutes" class="text-sm font-medium">Period Minutes</label>
          <input type="number" id="period_minutes"
            value="{% if let Some(f) = form %}{{ f.period_minutes.unwrap_or(60) }}{%else%}60{% endif %}"
            name="period_minutes" min="1"
            class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 font-mono text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" />
          <p class="text-xs text-gray-500">Defaults to 60. Controls the period in minutes for request counting.</p>
        </div>

        <div class="border-t border-dashed border-gray-200 pt-4 dark:border-gray-800">
          <h3 class="mb-3 text-base font-semibold">Remote Shutdown (optional)</h3>
          <div class="flex items-start gap-3">
            <input type="checkbox" id="can_be_turned_off" name="can_be_turned_off"
              value="{% if let Some(f) = form %}{{ f.can_be_turned_off }}{% else %}true{% endif %}"
              class="mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-800 dark:ring-offset-gray-900">
            <div>
              <label for="can_be_turned_off" class="text-sm font-medium">Can be turned off remotely</label>
              <p class="text-xs text-gray-500">Requires the target machine to be running the client_server.</p>
            </div>
          </div>
          <div id="turn_off_port_container" class="hidden mt-4 grid gap-2">
            <label for="turn_off_port" class="text-sm font-medium">Turn Off Port</label>
            <input type="number" id="turn_off_port" name="turn_off_port" min="1"
              value="{% if let Some(f) = form %}{{ f.turn_off_port.unwrap_or(3000) }}{% else %}3000{% endif %}"
              max="65535"
              class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 font-mono text-sm shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 dark:border-gray-700 dark:bg-gray-950" />
          </div>

        </div>
        <div class="flex items-center justify-end gap-3">
          <button type="reset"
            class="inline-flex items-center justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium shadow-sm transition hover:bg-gray-50 active:scale-[0.99] dark:border-gray-700 dark:bg-gray-900 dark:hover:bg-gray-800">
            Clear
          </button>
          <input type="submit" value="Add Machine"
            class="inline-flex cursor-pointer items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 active:scale-[0.99]" />
        </div>
      </form>
    </section>
  </div>
  <!-- Scripts -->
  <script>
    const canTurnOffCheckbox = document.getElementById('can_be_turned_off');
    const turnOffPortContainer = document.getElementById('turn_off_port_container');
    canTurnOffCheckbox.addEventListener('change', () => {
      turnOffPortContainer.classList.toggle('hidden', !canTurnOffCheckbox.checked);
    });

    const scanBtn = document.getElementById('scan-btn');
    const resultsContainer = document.getElementById('scan-results-container');
    const resultsTableBody = document.querySelector('#scan-results-table tbody');
    const scanStatus = document.getElementById('scan-status');

    function showResults() {
      resultsContainer.classList.remove('hidden');
    }

    scanBtn.addEventListener('click', async () => {
      scanBtn.textContent = 'üîé Scanning‚Ä¶';
      scanBtn.disabled = true;
      scanStatus.textContent = 'Scanning your network, this may take a moment‚Ä¶';
      resultsTableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-gray-500">Scanning‚Ä¶</td></tr>';
      showResults();

      try {
        const response = await fetch('/scan');
        if (!response.ok) throw new Error('Network scan failed');
        const devices = await response.json();

        resultsTableBody.innerHTML = '';
        if (!devices.length) {
          resultsTableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-gray-500">No devices found.</td></tr>';
        } else {
          devices.forEach(device => {
            const row = document.createElement('tr');
            row.className = 'align-middle';
            row.innerHTML = `
                <td class="px-4 py-3 font-mono text-xs sm:text-sm">${device.ip}</td>
                <td class="px-4 py-3 text-xs sm:text-sm">${device.hostname || '-'}</td>
                <td class="px-4 py-3 font-mono text-xs sm:text-sm">${device.mac}</td>
                <td class="px-4 py-3">
                  <button class="add-discovered-btn inline-flex items-center justify-center rounded-lg bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm transition hover:bg-indigo-700 active:scale-[0.99]" data-ip="${device.ip}" data-mac="${device.mac}" data-hostname="${device.hostname || ''}">
                    ‚ûï Add
                  </button>
                </td>`;
            resultsTableBody.appendChild(row);
          });
        }
        scanStatus.textContent = `Found ${devices.length} device${devices.length === 1 ? '' : 's'}.`;
      } catch (err) {
        console.error('Scan error:', err);
        resultsTableBody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-rose-600">Error during scan. Check server logs.</td></tr>';
        scanStatus.textContent = 'Scan failed.';
      } finally {
        scanBtn.textContent = 'üîç Scan Network';
        scanBtn.disabled = false;
        setTimeout(() => (scanStatus.textContent = ''), 4000);
      }
    });

    document.getElementById('scan-results-table').addEventListener('click', (event) => {
      if (event.target.classList.contains('add-discovered-btn')) {
        const btn = event.target;
        document.getElementById('ip').value = btn.dataset.ip;
        document.getElementById('mac').value = btn.dataset.mac;
        document.getElementById('description').value = btn.dataset.hostname;
        document.getElementById('add-machine-form').scrollIntoView({behavior: 'smooth', block: 'start'});
      }
    });

    document.querySelectorAll('.wol-form').forEach(form => {
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const button = form.querySelector('button[type="submit"]');
        const originalText = button.innerHTML;
        button.innerHTML = '‚ö° Sending‚Ä¶';
        button.disabled = true;

        try {
          const formData = new FormData(form);
          const response = await fetch(form.action, {
            method: form.method,
            body: new URLSearchParams(formData)
          });
          const responseText = await response.text();
          if (!response.ok) {
            throw new Error(responseText);
          }
          alert(responseText);
        } catch (error) {
          console.error('WOL error:', error);
          alert(`Error: ${error.message}`);
        } finally {
          button.innerHTML = originalText;
          button.disabled = false;
        }
      });
    });

    document.querySelectorAll('.turn-off-form').forEach(form => {
      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!confirm('Turn off this machine?')) return;

        const button = form.querySelector('button[type="submit"]');
        const originalText = button.innerHTML;
        button.innerHTML = 'üîå Sending‚Ä¶';
        button.disabled = true;

        try {
          const formData = new FormData(form);
          const response = await fetch(form.action, {
            method: form.method,
            body: new URLSearchParams(formData)
          });
          const responseText = await response.text();
          if (!response.ok) {
            throw new Error(responseText);
          }
          alert(responseText);
        } catch (error) {
          console.error('Turn off error:', error);
          alert(`Error: ${error.message}`);
        } finally {
          button.innerHTML = originalText;
          button.disabled = false;
        }
      });
    });

    // Machine health check function
    async function checkMachineHealth(machineIp, turnOffPort) {
      try {
        const response = await fetch('/machines/health', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            ip: machineIp,
            turn_off_port: parseInt(turnOffPort)
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Health check error:', error);
        return {status: 'error', message: error.message};
      }
    }

    // Update health badge
    function updateHealthBadge(badge, healthData) {
      const badgeElement = badge.querySelector('span');
      const dotElement = badgeElement.querySelector('span');

      if (healthData.status === 'online') {
        badgeElement.className = 'inline-flex items-center rounded-full bg-green-100 px-2 py-1 text-xs font-medium text-green-800 dark:bg-green-900 dark:text-green-200';
        dotElement.className = 'h-2 w-2 rounded-full bg-green-500 mr-1';
        badgeElement.innerHTML = '<span class="h-2 w-2 rounded-full bg-green-500 mr-1"></span>Online';
      } else if (healthData.status === 'offline' || healthData.status === 'error') {
        badgeElement.className = 'inline-flex items-center rounded-full bg-red-100 px-2 py-1 text-xs font-medium text-red-800 dark:bg-red-900 dark:text-red-200';
        dotElement.className = 'h-2 w-2 rounded-full bg-red-500 mr-1';
        badgeElement.innerHTML = '<span class="h-2 w-2 rounded-full bg-red-500 mr-1"></span>Offline';
      } else {
        badgeElement.className = 'inline-flex items-center rounded-full bg-gray-100 px-2 py-1 text-xs font-medium text-gray-800 dark:bg-gray-800 dark:text-gray-200';
        dotElement.className = 'h-2 w-2 rounded-full bg-gray-400 mr-1';
        badgeElement.innerHTML = '<span class="h-2 w-2 rounded-full bg-gray-400 mr-1"></span>Unknown';
      }
    }

    // Check health for all machines
    async function checkAllMachineHealth() {
      const badges = document.querySelectorAll('.machine-health-badge');
      for (const badge of badges) {
        const machineIp = badge.dataset.ip;
        const turnOffPort = badge.dataset.turnOffPort;

        const healthData = await checkMachineHealth(machineIp, turnOffPort);
        updateHealthBadge(badge, healthData);
      }
    }

    // Initial health check and periodic updates
    document.addEventListener('DOMContentLoaded', function () {
      checkAllMachineHealth();

      // Check health every 30 seconds
      setInterval(checkAllMachineHealth, 30000);
    });
  </script>
</body>

</html>
